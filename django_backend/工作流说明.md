# 工具增强工作流说明

## 概述

本系统实现了一个**工具增强的工作流**，当检测到用户输入命中特定工具类意图时，系统会先执行本地工具函数进行初步分析，然后将工具执行结果整理后传递给大语言模型（LLM），由LLM基于工具结果进行智能分析和流式响应。

## 工作流程

### 1. 意图识别阶段

```
用户输入："分析网络连接问题"
    ↓
意图分类器识别意图类型
    ↓
判断是否为工具类意图
    ├─ 是 → 进入工具执行流程
    └─ 否 → 进入常规RAG/对话流程
```

**工具类意图类型：**
- `network_analysis` - 网络分析工具
- `error_analysis` - 错误分析工具
- `performance_analysis` - 性能分析工具

### 2. 工具执行阶段

当检测到工具类意图时，系统会：

1. **调用对应的本地工具函数**
   - `run_network_analysis()` - 执行网络分析
   - `run_error_analysis()` - 执行错误分析
   - `run_performance_analysis()` - 执行性能分析

2. **工具函数执行逻辑**
   - 调用日志检索系统（`get_log_system()`）
   - 使用增强查询关键词进行日志检索
   - 返回检索到的相关日志结果（最多5条）

3. **工具执行结果示例**
   ```
   📡 网络分析结果：
   检索到 5 条相关日志：
   1. (服务='GatewayService', 级别='WARN', 错误='REGION_BLOCK', ...)
   2. (服务='GatewayService', 级别='WARN', 错误='DNS_SLOW', ...)
   ...
   ```

### 3. 消息整理阶段

工具执行完成后，系统会将结果整理成增强的Prompt：

```
用户问题：{原始用户输入}

工具执行结果：
{工具函数返回的原始数据}

请基于以上工具执行结果，对用户的问题进行详细分析和回答。要求：
1. 对工具结果进行总结和分析
2. 指出关键问题和异常
3. 提供具体的建议和解决方案
4. 用清晰、专业的方式组织回答
```

### 4. LLM响应阶段

整理后的消息会传递给DeepSeek LLM，LLM会：

1. **分析工具结果**
   - 理解工具返回的原始数据
   - 识别关键问题和异常

2. **生成专业回答**
   - 总结工具执行结果
   - 指出关键问题和异常
   - 提供具体的建议和解决方案
   - 用清晰、专业的方式组织回答

3. **流式返回**
   - 支持流式输出，提供更好的用户体验
   - 逐步生成回答内容

## 完整流程图

```
┌─────────────────┐
│  用户输入问题   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  意图分类器     │
│  识别意图类型   │
└────────┬────────┘
         │
    ┌────┴────┐
    │         │
    ▼         ▼
┌─────────┐ ┌──────────────┐
│工具类意图│ │ 常规意图     │
└────┬────┘ └──────┬───────┘
     │             │
     ▼             ▼
┌─────────┐   ┌──────────────┐
│执行工具函数│ │ RAG检索/直接对话│
│获取原始数据│ └──────┬───────┘
└────┬────┘         │
     │              │
     ▼              │
┌─────────┐         │
│整理工具结果│        │
│构建增强Prompt│       │
└────┬────┘         │
     │              │
     └──────┬───────┘
            │
            ▼
     ┌──────────┐
     │  DeepSeek │
     │    LLM    │
     └────┬─────┘
          │
          ▼
     ┌──────────┐
     │ 流式生成回答│
     └────┬─────┘
          │
          ▼
     ┌──────────┐
     │  返回给用户 │
     └──────────┘
```

## 优势

### 1. 更智能的分析
- **工具函数**：快速检索相关数据，提供原始信息
- **LLM分析**：基于原始数据进行深度分析，提供专业见解

### 2. 更准确的回答
- 工具函数确保数据来源准确（基于日志系统）
- LLM确保回答专业且易读

### 3. 更好的用户体验
- 工具执行快速，提供即时反馈
- LLM流式生成，保持交互体验
- 最终回答专业、清晰、易读

### 4. 可扩展性
- 新增工具只需：
  1. 在`IntentType`中添加新意图类型
  2. 在`TOOL_INTENTS`中注册
  3. 实现对应的`run_xxx()`方法
  4. 添加到`self.tools`字典

## 代码实现位置

### 核心文件

1. **意图分类器**：`deepseek_api/intent_classifier.py`
   - 定义工具类意图类型
   - 实现工具执行函数
   - 提供意图识别功能

2. **服务层**：`deepseek_api/services.py`
   - `deepseek_r1_api_call()` - 非流式接口
   - `deepseek_r1_api_call_stream()` - 流式接口
   - 实现工具执行 → LLM响应的完整流程

### 关键代码片段

**工具执行与LLM调用：**
```python
# 1. 意图识别
intent_result = classifier.classify_intent(prompt)

# 2. 工具执行
if intent_result.intent in TOOL_INTENTS:
    tool_result = classifier.tools[intent_result.intent](prompt)
    
    # 3. 构建增强Prompt
    enhanced_prompt = f"""用户问题：{prompt}
    
工具执行结果：
{tool_result}

请基于以上工具执行结果，对用户的问题进行详细分析和回答..."""
    
    # 4. LLM响应
    response = llm.chat([ChatMessage(role="user", content=enhanced_prompt)])
```

## 使用示例

### 示例1：网络分析

**用户输入：** "分析网络连接问题"

**工作流程：**
1. 意图识别 → `network_analysis`
2. 执行工具 → 检索网络相关日志（5条）
3. 整理结果 → 构建包含日志的增强Prompt
4. LLM分析 → 基于日志进行专业分析
5. 流式返回 → 逐步生成回答

**最终回答：**
```
根据网络分析工具的执行结果，我发现了以下关键问题：

1. **地区封禁问题**：检测到IP 203.192.1.1被地区封禁...
2. **DNS解析延迟**：DNS解析延迟达到1.2秒...
3. **请求体压缩失败**：检测到gzip压缩失败...

**建议解决方案**：
- 检查地区封禁规则...
- 优化DNS配置...
- 检查压缩算法配置...
```

### 示例2：错误分析

**用户输入：** "分析系统错误"

**工作流程：**
1. 意图识别 → `error_analysis`
2. 执行工具 → 检索错误相关日志
3. 整理结果 → 构建增强Prompt
4. LLM分析 → 分析错误模式和建议
5. 流式返回 → 生成专业回答

## 注意事项

1. **工具函数必须返回字符串**
   - 工具执行结果会直接嵌入到Prompt中
   - 建议格式化输出，便于LLM理解

2. **Prompt长度限制**
   - 工具结果不应过长，避免超出LLM上下文窗口
   - 当前限制：每条日志最多500字符

3. **流式输出支持**
   - 工具增强的工作流完全支持流式输出
   - 保持与常规对话一致的体验

4. **错误处理**
   - 如果工具执行失败，会记录错误日志
   - 系统会回退到常规流程或返回错误信息

## 未来扩展

可以进一步扩展的功能：

1. **多工具组合**
   - 支持一次调用多个工具
   - 工具结果合并后传递给LLM

2. **工具参数提取**
   - 从用户输入中提取工具参数
   - 更精确的工具调用

3. **工具结果缓存**
   - 缓存工具执行结果
   - 提高响应速度

4. **工具链式调用**
   - 一个工具的结果作为另一个工具的输入
   - 实现更复杂的分析流程

---

**文档版本：** 1.0  
**最后更新：** 2024年

