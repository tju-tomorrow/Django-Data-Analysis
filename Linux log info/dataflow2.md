================================================================================
🚀 [数据流追踪] 开始处理 Chat 请求
================================================================================
✅ [认证成功] 用户: ckx, API Key: AfMAbwPJ...
📝 [请求参数] session_id: '3', query_type: 'analysis'
📝 [用户输入] hello

🔍 [会话查询] 正在获取会话 session_id='3', user='ckx'
🔍 [数据库查询] 查找会话: session_id='3', user='ckx'
📂 [数据库操作] 加载现有会话 - ID: 21, session_id: '3'
📂 [现有会话详情] 用户: ckx, 上下文长度: 0 字符
📂 [会话创建时间] 2025-10-23 17:47:58.416088+00:00
📂 [会话更新时间] 2025-10-23 18:00:09.064986+00:00
📊 [会话状态] 会话ID: 3
📊 [会话用户] ckx
📊 [历史长度] 0 字符
📊 [历史内容] 空（新会话）

🧠 [智能对话管理] 开始分析对话类型和上下文...
🧠 [历史解析] 解析出 0 轮历史对话
🧠 [对话分类] 当前对话类型: general_qa
🧠 [上下文压缩] 压缩后保留 0 轮对话
🧠 [RAG决策] 是否使用RAG检索: False

🔧 [上下文构建]
   原始历史长度: 0 字符
   压缩后长度: 12 字符
   对话类型: general_qa
   使用RAG: False
🔧 [LLM上下文] ↓↓↓
------------------------------------------------------------
用户：hello
回复：
------------------------------------------------------------
🔧 [对话模式] 仅使用对话历史，不进行RAG检索

🔍 [缓存检查] 检查是否有缓存回复...
🔍 [缓存查询] 缓存键: reply:ckx:3:-5794228592325745742
❌ [缓存未命中] 缓存中没有找到对应回复
❌ [缓存未命中] 调用大模型API...
💬 [对话模式] 纯对话，不使用RAG检索

🤖 [大模型调用] 开始调用 DeepSeek-R1 API
🤖 [调用参数] query_type: 'general_chat'
🤖 [Prompt长度] 12 字符
/home/victor/miniconda3/envs/chenkaixuan_DA/lib/python3.13/site-packages/pydantic/_internal/_generate_schema.py:2249: UnsupportedFieldAttributeWarning: The 'validate_default' attribute with value True was provided to the `Field()` function, which has no effect in the context it was used. 'validate_default' is field-specific metadata, and can only be attached to a model field using `Annotated` metadata or by assignment. This may have happened because an `Annotated` type alias using the `type` statement was used, or if the `Field()` function was attached to a single member of a union type.
  warnings.warn(
INFO:deepseek_api.services:初始化 TopKLogSystem 单例实例...
INFO:deepseek_api.services:使用模型: LLM=qwen2.5:3b, Embedding=nomic-embed-text
INFO:topklogsystem:找到现有向量索引，直接加载...
INFO:topklogsystem:成功加载现有向量索引，跳过构建步骤
INFO:deepseek_api.services:TopKLogSystem 初始化完成！
🤖 [API请求] 发送请求到大模型...
💬 [通用对话模式] 跳过RAG检索，直接调用LLM
INFO:httpx:HTTP Request: POST http://localhost:11434/api/chat "HTTP/1.1 200 OK"
🤖 [API响应] 收到回复，长度: 49 字符
🤖 [回复内容] 您好，请问有什么可以帮助您的吗？您可以告诉我您需要了解的技术领域或问题细节，我会尽力为您提供帮助。
🤖 [大模型回复] 长度: 49 字符
🤖 [回复内容] 您好，请问有什么可以帮助您的吗？您可以告诉我您需要了解的技术领域或问题细节，我会尽力为您提供帮助。
💾 [缓存保存] 保存回复到缓存
💾 [缓存键] reply:ckx:3:-5794228592325745742
💾 [缓存内容] 长度: 49 字符, 过期时间: 3600秒
💾 [回复预览] 您好，请问有什么可以帮助您的吗？您可以告诉我您需要了解的技术领域或问题细节，我会尽力为您提供帮助。
✅ [缓存完成] 回复已成功保存到缓存
💾 [缓存保存] 回复已缓存

💾 [智能上下文保存] 使用对话管理器更新历史...
💾 [对话轮次] 添加新轮次，当前总轮次: 1
💾 [元数据] {'query_type': 'analysis', 'conversation_type': 'general_qa', 'used_rag': False, 'original_turns': 0, 'compressed_turns': 0}
💾 [上下文更新] 长度变化: 0 → 62 字符
💾 [压缩效果] 压缩比: 62.00
💾 [保存完成] 智能上下文已保存到数据库
💾 [最终状态] 会话ID: 3, 轮次: 1, 长度: 62 字符

✅ [请求完成] 返回回复给前端
================================================================================
[26/Oct/2025 13:18:41] "POST /api/chat HTTP/1.1" 200 307
================================================================================
🚀 [数据流追踪] 开始处理 Chat 请求
================================================================================
✅ [认证成功] 用户: ckx, API Key: AfMAbwPJ...
📝 [请求参数] session_id: '3', query_type: 'analysis'
📝 [用户输入] who are u

🔍 [会话查询] 正在获取会话 session_id='3', user='ckx'
🔍 [数据库查询] 查找会话: session_id='3', user='ckx'
📂 [数据库操作] 加载现有会话 - ID: 21, session_id: '3'
📂 [现有会话详情] 用户: ckx, 上下文长度: 62 字符
📂 [会话创建时间] 2025-10-23 17:47:58.416088+00:00
📂 [会话更新时间] 2025-10-26 13:18:41.960700+00:00
📂 [历史上下文预览] 用户：hello
回复：您好，请问有什么可以帮助您的吗？您可以告诉我您需要了解的技术领域或问题细节，我会尽力为您提供帮助。

INFO:deepseek_api.services:会话 3（用户：ckx）加载旧会话
📊 [会话状态] 会话ID: 3
📊 [会话用户] ckx
📊 [历史长度] 62 字符
📊 [历史内容预览] 用户：hello
回复：您好，请问有什么可以帮助您的吗？您可以告诉我您需要了解的技术领域或问题细节，我会尽力为您提供帮助。


🧠 [智能对话管理] 开始分析对话类型和上下文...
🧠 [历史解析] 解析出 1 轮历史对话
🧠 [对话分类] 当前对话类型: general_qa
🧠 [上下文压缩] 压缩后保留 1 轮对话
🧠 [RAG决策] 是否使用RAG检索: False

🔧 [上下文构建]
   原始历史长度: 62 字符
   压缩后长度: 78 字符
   对话类型: general_qa
   使用RAG: False
🔧 [LLM上下文] ↓↓↓
------------------------------------------------------------
用户：hello
回复：您好，请问有什么可以帮助您的吗？您可以告诉我您需要了解的技术领域或问题细节，我会尽力为您提供帮助。
用户：who are u
回复：
------------------------------------------------------------
🔧 [对话模式] 仅使用对话历史，不进行RAG检索
INFO:deepseek_api.api:传递给大模型的prompt：
用户：hello
回复：您好，请问有什么可以帮助您的吗？您可以告诉我您需要了解的技术领域或问题细节，我会尽力为您提供帮助。
用户：who are u
回复：
INFO:deepseek_api.api:查询类型：analysis

🔍 [缓存检查] 检查是否有缓存回复...
🔍 [缓存查询] 缓存键: reply:ckx:3:201201633434264640
❌ [缓存未命中] 缓存中没有找到对应回复
❌ [缓存未命中] 调用大模型API...
💬 [对话模式] 纯对话，不使用RAG检索

🤖 [大模型调用] 开始调用 DeepSeek-R1 API
🤖 [调用参数] query_type: 'general_chat'
🤖 [Prompt长度] 78 字符
🤖 [API请求] 发送请求到大模型...
💬 [通用对话模式] 跳过RAG检索，直接调用LLM
INFO:httpx:HTTP Request: POST http://localhost:11434/api/chat "HTTP/1.1 200 OK"
🤖 [API响应] 收到回复，长度: 47 字符
🤖 [回复内容] 我是Qwen，由阿里云开发的AI助手，旨在提供各种技术问题的答案和帮助。有什么我可以帮您的吗？
🤖 [大模型回复] 长度: 47 字符
🤖 [回复内容] 我是Qwen，由阿里云开发的AI助手，旨在提供各种技术问题的答案和帮助。有什么我可以帮您的吗？
💾 [缓存保存] 保存回复到缓存
💾 [缓存键] reply:ckx:3:201201633434264640
💾 [缓存内容] 长度: 47 字符, 过期时间: 3600秒
💾 [回复预览] 我是Qwen，由阿里云开发的AI助手，旨在提供各种技术问题的答案和帮助。有什么我可以帮您的吗？
✅ [缓存完成] 回复已成功保存到缓存
💾 [缓存保存] 回复已缓存

💾 [智能上下文保存] 使用对话管理器更新历史...
💾 [对话轮次] 添加新轮次，当前总轮次: 2
💾 [元数据] {'query_type': 'analysis', 'conversation_type': 'general_qa', 'used_rag': False, 'original_turns': 1, 'compressed_turns': 1}
💾 [上下文更新] 长度变化: 62 → 126 字符
💾 [压缩效果] 压缩比: 2.03
💾 [保存完成] 智能上下文已保存到数据库
💾 [最终状态] 会话ID: 3, 轮次: 2, 长度: 126 字符

✅ [请求完成] 返回回复给前端
================================================================================
[26/Oct/2025 13:20:16] "POST /api/chat HTTP/1.1" 200 265
================================================================================
🚀 [数据流追踪] 开始处理 Chat 请求
================================================================================
✅ [认证成功] 用户: ckx, API Key: AfMAbwPJ...
📝 [请求参数] session_id: '3', query_type: 'analysis'
📝 [用户输入] how to solve database error

🔍 [会话查询] 正在获取会话 session_id='3', user='ckx'
🔍 [数据库查询] 查找会话: session_id='3', user='ckx'
📂 [数据库操作] 加载现有会话 - ID: 21, session_id: '3'
📂 [现有会话详情] 用户: ckx, 上下文长度: 126 字符
📂 [会话创建时间] 2025-10-23 17:47:58.416088+00:00
📂 [会话更新时间] 2025-10-26 13:20:16.301087+00:00
📂 [历史上下文预览] 用户：hello
回复：您好，请问有什么可以帮助您的吗？您可以告诉我您需要了解的技术领域或问题细节，我会尽力为您提供帮助。
用户：who are u
回复：我是Qwen，由阿里云开发的AI助手，旨在提供各种技术问题的答案和帮助。有什么我可以帮您的吗？

INFO:deepseek_api.services:会话 3（用户：ckx）加载旧会话
📊 [会话状态] 会话ID: 3
📊 [会话用户] ckx
📊 [历史长度] 126 字符
📊 [历史内容预览] 用户：hello
回复：您好，请问有什么可以帮助您的吗？您可以告诉我您需要了解的技术领域或问题细节，我会尽力为您提供帮助。
用户：who are u
回复：我是Qwen，由阿里云开发的AI助手，旨在提供各种技术问题的答案和帮助。有什么我可以帮您的吗？


🧠 [智能对话管理] 开始分析对话类型和上下文...
🧠 [历史解析] 解析出 2 轮历史对话
🧠 [对话分类] 当前对话类型: log_analysis
🧠 [上下文压缩] 压缩后保留 2 轮对话
🧠 [RAG决策] 是否使用RAG检索: True

🔧 [上下文构建]
   原始历史长度: 126 字符
   压缩后长度: 160 字符
   对话类型: log_analysis
   使用RAG: True
🔧 [LLM上下文] ↓↓↓
------------------------------------------------------------
用户：hello
回复：您好，请问有什么可以帮助您的吗？您可以告诉我您需要了解的技术领域或问题细节，我会尽力为您提供帮助。
用户：who are u
回复：我是Qwen，由阿里云开发的AI助手，旨在提供各种技术问题的答案和帮助。有什么我可以帮您的吗？
用户：how to solve database error
回复：
------------------------------------------------------------
🔧 [RAG模式] 将使用对话历史 + RAG检索结果
INFO:deepseek_api.api:传递给大模型的prompt：
用户：hello
回复：您好，请问有什么可以帮助您的吗？您可以告诉我您需要了解的技术领域或问题细节，我会尽力为您提供帮助。
用户：who are u
回复：我是Qwen，由阿里云开发的AI助手，旨在提供各种技术问题的答案和帮助。有什么我可以帮您的吗？
用户：how to solve database error
回复：
INFO:deepseek_api.api:查询类型：analysis

🔍 [缓存检查] 检查是否有缓存回复...
🔍 [缓存查询] 缓存键: reply:ckx:3:1035415123241840152
❌ [缓存未命中] 缓存中没有找到对应回复
❌ [缓存未命中] 调用大模型API...
🔍 [RAG模式] 使用RAG检索 + 对话历史

🤖 [大模型调用] 开始调用 DeepSeek-R1 API
🤖 [调用参数] query_type: 'analysis'
🤖 [Prompt长度] 160 字符
🤖 [API请求] 发送请求到大模型...
🔍 [日志分析模式] 进行RAG检索
INFO:httpx:HTTP Request: POST http://localhost:11434/api/embed "HTTP/1.1 200 OK"
INFO:httpx:HTTP Request: POST http://localhost:11434/api/chat "HTTP/1.1 200 OK"
🤖 [API响应] 收到回复，长度: 1380 字符
🤖 [回复内容] ## 分析要求
请按照以下步骤进行分析：

### 第一步：问题识别
从日志中提取关键错误信息、异常模式、性能指标

**问题摘要**
用户在使用过程中遇到了数据库连接池耗尽的问题，导致无法获取新的数...
🤖 [大模型回复] 长度: 1380 字符
🤖 [回复内容] ## 分析要求
请按照以下步骤进行分析：

### 第一步：问题识别
从日志中提取关键错误信息、异常模式、性能指标

**问题摘要**
用户在使用过程中遇到了数据库连接池耗尽的问题，导致无法获取新的数...
💾 [缓存保存] 保存回复到缓存
💾 [缓存键] reply:ckx:3:1035415123241840152
💾 [缓存内容] 长度: 1380 字符, 过期时间: 3600秒
💾 [回复预览] ## 分析要求
请按照以下步骤进行分析：

### 第一步：问题识别
从日志中提取关键错误信息、异常模式、性能指标

**问题摘要**
用户在使用过程中遇到了数...
✅ [缓存完成] 回复已成功保存到缓存
💾 [缓存保存] 回复已缓存

💾 [智能上下文保存] 使用对话管理器更新历史...
💾 [对话轮次] 添加新轮次，当前总轮次: 3
💾 [元数据] {'query_type': 'analysis', 'conversation_type': 'log_analysis', 'used_rag': True, 'original_turns': 2, 'compressed_turns': 2}
💾 [上下文更新] 长度变化: 126 → 1541 字符
💾 [压缩效果] 压缩比: 12.23
💾 [保存完成] 智能上下文已保存到数据库
💾 [最终状态] 会话ID: 3, 轮次: 3, 长度: 1541 字符

✅ [请求完成] 返回回复给前端
================================================================================
[26/Oct/2025 13:23:12] "POST /api/chat HTTP/1.1" 200 6431


